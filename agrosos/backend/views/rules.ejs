<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reglas Existentes</title>
  <link rel="stylesheet" href="/css/view-rules.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>

<body>
  <div id="view-existing-rules-container">
    <div class="view-existing-rule-header">
      <h1 class="view-existing-rule-title">&#128221; Reglas</h1>
    </div>

    <!-- Lista de reglas -->
    <div class="view-existing-rule-cards-container">
      <% if (rules.length === 0) { %>
      <div class="view-no-rules-message">
        <h2>Añadir regla</h2>
        <button class="view-add-rule-button" onclick="window.location.href='/add-rule'">+</button>
      </div>
      <% } else { %>
      <% rules.forEach(function(rule) { %>
      <% const crop = crops.find(crop => crop.id === rule.crop_id); %>
      <div class="view-existing-rule-card" tabindex="0">
        <div class="view-existing-rule-card-info">
          <p><strong>Nombre:</strong> <%= rule.name %></p>
          <p><strong>Cultivo:</strong> <%= crop ? crop.name : 'Cultivo no encontrado' %></p>
          <p><strong>Condiciones:</strong> <%= (rule.rule_info) %></p>
        </div>
        <div class="view-existing-rule-card-actions">
          <button class="view-existing-rule-edit-button" onclick="openEditModal(<%= rule.id %>, '<%= crop ? crop.id : '' %>', '<%= rule.sensor %>', '<%= rule.actuator %>', '<%= rule.actuator_options %>')"> &#9998; </button>
          <button class="view-existing-rule-delete-button" onclick="openModal(<%= rule.id %>)"> &#128465; </button>
        </div>
      </div>
      <% }) %>
      <% } %>
    </div>
    <button id="add-rule-btn">Añadir Regla</button>

    <div id="add-rule-modal-overlay" class="modal-overlay" style="display: none;">
      <div class="modal-content">
        <h2>Añadir Reglita</h2>
        <form id="add-rule-form" onsubmit="addRule(event)">
          <label for="add-rule-name">Nombre de la Regla:</label>
          <input type="text" id="add-rule-name" name="name" required>

          <label for="add-crop">Cultivo:</label>
          <select id="add-crop" name="crop" required>
            <% crops.forEach(function(crop) { %>
            <option value="<%= crop.id %>"><%= crop.name %></option>
            <% }) %>
          </select>

          <label for="add-sensor">Sensor:</label>
          <select id="add-sensor" name="sensor" required onchange="toggleAddConditions()">
            <option value="temperatura">Temperatura</option>
            <option value="humedad">Humedad</option>
            <option value="temperatura_terreno">Temperatura del terreno</option>
            <option value="humedad_terreno">Humedad del terreno</option>
          </select>

          <div id="add-conditions-container" style="display: none;">
            <label for="add-operator">Operador:</label>
            <select id="add-operator" name="operator" required>
              <option value="<">
                <</option>
              <option value="=">=</option>
              <option value=">">></option>
            </select>

            <label for="add-value">Valor:</label>
            <input type="number" id="add-value" name="value" required>

            <label for="add-unit">Unidad:</label>
            <input type="text" id="add-unit" name="unit" required>
          </div>

          <label for="add-actuator">Actuador:</label>
          <select id="add-actuator" name="actuator" required onchange="updateAddActuatorOptions()">
            <option value="riego">Riego</option>
            <option value="ventilacion">Ventilación</option>
            <option value="cobertura_cultivos">Cobertura de cultivos</option>
            <option value="apertura_ventanas">Apertura de ventanas</option>
          </select>

          <label for="add-actuator-options">Opciones:</label>
          <select id="add-actuator-options" name="actuator-options" required>
          </select>

          <button type="submit">Añadir Regla</button>
        </form>
        <button onclick="closeAddModal()">Cancelar</button>
      </div>
    </div>
    <!-- Formulario de edición de regla -->
    <div id="edit-rule-modal-overlay" style="display: none;">
      <div class="view-existing-rule-modal-content">
        <h2>Modificar Regla</h2>
        <form id="edit-rule-form" onsubmit="updateRule(event)">
          <!-- Cultivo -->
          <label for="crop">Cultivo:</label>
          <select id="crop" name="crop" required>
            <% crops.forEach(function(crop) { %>
            <option value="<%= crop.id %>"><%= crop.name %></option>
            <% }) %>
          </select>

          <!-- Sensor -->
          <label for="sensor">Sensor:</label>
          <select id="sensor" name="sensor" required onchange="toggleConditions()">
            <option value="temperatura">Temperatura</option>
            <option value="humedad">Humedad</option>
            <option value="temperatura_terreno">Temperatura del terreno</option>
            <option value="humedad_terreno">Humedad del terreno</option>
          </select>

          <!-- Condiciones (solo se muestra si el sensor es temperatura o humedad) -->
          <div id="conditions-container" style="display: none;">
            <label for="operator">Operador:</label>
            <select id="operator" name="operator" required>
              <option value="<">
                < </option>
              <option value="=">=</option>
              <option value=">">></option>
            </select>

            <label for="value">Valor:</label>
            <input type="number" id="value" name="value" required>

            <label for="unit">Unidad:</label>
            <input type="text" id="unit" name="unit" required>
          </div>

          <!-- Actuador -->
          <label for="actuator">Actuador:</label>
          <select id="actuator" name="actuator" required>
            <option value="riego">Riego</option>
            <option value="ventilacion">Ventilación</option>
            <option value="cobertura_cultivos">Cobertura de cultivos</option>
            <option value="apertura_ventanas">Apertura de ventanas</option>
          </select>

          <!-- Opciones de Actuador -->
          <label for="actuator-options">Opciones:</label>
          <select id="actuator-options" name="actuator-options" required>
            <!-- Las opciones cambiarán según el actuador seleccionado -->
          </select>

          <button type="submit">Guardar Cambios</button>
        </form>


        <button onclick="closeEditModal()">Cancelar</button>
      </div>
    </div>

    <div id="view-existing-rule-modal-overlay" style="display: none;">
      <div class="view-existing-rule-modal-content">
        <h2>¿Estás seguro de que deseas eliminar esta regla?</h2>
        <div class="view-existing-rule-modal-buttons">
          <button class="view-existing-rule-modal-button view-existing-rule-modal-confirm" id="confirmDelete">Aceptar</button>
          <button class="view-existing-rule-modal-button view-existing-rule-modal-cancel" onclick="closeModal()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
  <script src="http://localhost:3000/js/rules.js"></script>
</body>

</html>